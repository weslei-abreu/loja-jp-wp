!function(e){"use strict";var t,a=Stripe(dokanStripeExpressPRData.stripe.key,{locale:dokanStripeExpressPRData.stripe.locale,apiVersion:dokanStripeExpressPRData.stripe.apiVersion});const n={ajaxEndpoint:e=>dokanStripeExpressPRData.ajaxUrl.toString().replace("%%endpoint%%","dokan_stripe_express_"+e),makeRequest:(t,a={},s=null,i="POST")=>{var r={type:i,data:a,url:n.ajaxEndpoint(t)};return s&&(r.dataType=s),e.ajax(r)},getCartDetails:()=>{e.when(n.makeRequest("get_cart_details",{security:dokanStripeExpressPRData.nonce.payment})).then(n.startPaymentRequest)},getAttributes:()=>{var t=e(".variations_form").find(".variations select"),a={},n=0,s=0;return t.each((function(){var t=e(this).data("attribute_name")||e(this).attr("name"),i=e(this).val()||"";i.length>0&&s++,n++,a[t]=i})),{count:n,chosenCount:s,data:a}},processPaymentResponse:(e,t)=>n.makeRequest("create_order",n.getOrderData(e,t),"json"),getOrderData:(e,t)=>{const a=n,s=e.paymentMethod,i=s.billing_details.email,r=s.billing_details.phone,o=s.billing_details.address,p=a.isValidString(s.billing_details.name)?s.billing_details.name:e.payerName,d=e.shippingAddress,u={_wpnonce:dokanStripeExpressPRData.nonce.checkout,billing_company:"",billing_first_name:"",billing_last_name:"",billing_email:null!==i?i:e.payerEmail,billing_phone:null!==r?r:e.payerPhone&&e.payerPhone.replace("/[() -]/g",""),billing_country:"",billing_address_1:"",billing_address_2:"",billing_city:"",billing_state:"",billing_postcode:"",shipping_first_name:"",shipping_last_name:"",shipping_company:"",shipping_country:"",shipping_address_1:"",shipping_address_2:"",shipping_city:"",shipping_state:"",shipping_postcode:"",shipping_method:[null===e.shippingOption?null:e.shippingOption.id],order_comments:"",payment_method:dokanStripeExpressPRData.stripe.paymentMethod,ship_to_different_address:1,terms:1,payment_method_source:s.id,payment_request_type:t};return a.isValidString(p)&&(u.billing_first_name=p.split(" ").slice(0,1).join(" "),u.billing_last_name=p.split(" ").slice(1).join(" ")),null!==o&&(u.billing_country=o.country,u.billing_address_1=o.line1,u.billing_address_2=o.line2,u.billing_city=o.city,u.billing_state=o.state,u.billing_postcode=o.postal_code),d&&(u.shipping_first_name=d.recipient.split(" ").slice(0,1).join(" "),u.shipping_last_name=d.recipient.split(" ").slice(1).join(" "),u.shipping_company=d.organization,u.shipping_country=d.country,u.shipping_address_1=void 0===d.addressLine[0]?"":d.addressLine[0],u.shipping_address_2=void 0===d.addressLine[1]?"":d.addressLine[1],u.shipping_city=d.city,u.shipping_state=d.region,u.shipping_postcode=d.postalCode),a.isValidString(u.billing_first_name)||(u.billing_first_name=a.isValidString(u.shipping_first_name)?u.shipping_first_name:dokanStripeExpressPRData.customer.first_name),a.isValidString(u.billing_last_name)||(u.billing_last_name=a.isValidString(u.shipping_last_name)?u.shipping_last_name:dokanStripeExpressPRData.customer.last_name),u},prepareErrorMessage:t=>e('<div class="woocommerce-error" />').text(t),isValidString:e=>e&&"string"==typeof e&&e.length>0,showErrorMessage:t=>{if(e(".woocommerce-error").remove(),dokanStripeExpressPRData.isProductPage){var a=e(".product").first();a.before(t),e("html, body").animate({scrollTop:a.prev(".woocommerce-error").offset().top},600)}else{var n=e(".shop_table.cart").closest("form");n.before(t),e("html, body").animate({scrollTop:n.prev(".woocommerce-error").offset().top},600)}},abortPayment:(e,t)=>{e.complete("fail"),n.showErrorMessage(t)},completePayment:(e,t)=>{n.block(),e.complete("success"),window.location=t},block:()=>{e.blockUI({message:null,overlayCSS:{background:"#fff",opacity:.6}})},updateShippingOptions:(e,a)=>n.makeRequest("get_shipping_options",{security:dokanStripeExpressPRData.nonce.shipping,country:a.country,state:a.region,postcode:a.postalCode,city:a.city,address:void 0===a.addressLine[0]?"":a.addressLine[0],address_2:void 0===a.addressLine[1]?"":a.addressLine[1],payment_request_type:t,is_product_page:dokanStripeExpressPRData.isProductPage}),updateShippingDetails:(e,a)=>n.makeRequest("update_shipping_method",{security:dokanStripeExpressPRData.nonce.updateShipping,shipping_method:[a.id],payment_request_type:t,is_product_page:dokanStripeExpressPRData.isProductPage}),addToCart:()=>{var t=e(".single_add_to_cart_button").val();e(".single_variation_wrap").length&&(t=e(".single_variation_wrap").find('input[name="product_id"]').val());var a={security:dokanStripeExpressPRData.nonce.addToCart,product_id:t,qty:e(".quantity .qty").val(),attributes:e(".variations_form").length?n.getAttributes().data:[]},s=e("form.cart").serializeArray();return e.each(s,(function(e,t){if(/^addon-/.test(t.name))if(/\[\]$/.test(t.name)){var n=t.name.substring(0,t.name.length-2);a[n]?a[n].push(t.value):a[n]=[t.value]}else a[t.name]=t.value})),n.makeRequest("add_to_cart",a)},clearCart:()=>{n.makeRequest("clear_cart",{security:dokanStripeExpressPRData.nonce.clearCart})},getRequestOptionsFromLocal:()=>({total:dokanStripeExpressPRData.product.total,currency:dokanStripeExpressPRData.checkout.currencyCode,country:dokanStripeExpressPRData.checkout.countryCode,requestPayerName:!0,requestPayerEmail:!0,requestPayerPhone:dokanStripeExpressPRData.checkout.payerPhoneNeeded,requestShipping:dokanStripeExpressPRData.product.requestShipping,displayItems:dokanStripeExpressPRData.product.displayItems}),startPaymentRequest:s=>{var i,r;dokanStripeExpressPRData.isProductPage?(r=n.getRequestOptionsFromLocal(),i=r):(r={total:s.order_data.total,currency:s.order_data.currency,country:s.order_data.country_code,requestPayerName:!0,requestPayerEmail:!0,requestPayerPhone:dokanStripeExpressPRData.checkout.payerPhoneNeeded,requestShipping:!!s.shipping_required,displayItems:s.order_data.displayItems},i=s.order_data),"PR"===r.country&&(r.country="US");try{var o=a.paymentRequest(r),p=a.elements({locale:dokanStripeExpressPRData.button.locale}),d=n.createPaymentRequestButton(p,o);o.canMakePayment().then((function(e){e&&(t=e.applePay?"apple_pay":e.googlePay?"google_pay":"payment_request_api",n.attachBtnEventListeners(d,o),n.showPaymentRequestButton(d))})),o.on("shippingaddresschange",(function(t){e.when(n.updateShippingOptions(i,t.shippingAddress)).then((function(e){let a={status:e.result,shippingOptions:[],total:e.total,displayItems:e.displayItems};e.shipping_options&&e.shipping_options.length&&(a.shippingOptions=e.shipping_options),t.updateWith(a)}))})),o.on("shippingoptionchange",(function(t){e.when(n.updateShippingDetails(i,t.shippingOption)).then((function(e){"success"===e.result&&t.updateWith({status:"success",total:e.total,displayItems:e.displayItems}),"fail"===e.result&&t.updateWith({status:"fail"})}))})),o.on("paymentmethod",(async a=>{"no"===dokanStripeExpressPRData.stripe.allowPrepaidCard&&"prepaid"===a.source.card.funding?n.abortPayment(a,n.dokanStripeExpressPaymentRequest.prepareErrorMessage(dokanStripeExpressPRData.i18n.error.noPrepaidCard)):e.when(n.processPaymentResponse(a,t)).then((function(e){"success"===e.result?n.completePayment(a,e.redirect):n.abortPayment(a,e.messages)}))}))}catch(e){console.error(e)}},getSelectedProductData:()=>{var t=e(".single_add_to_cart_button").val();e(".single_variation_wrap").length&&(t=e(".single_variation_wrap").find('input[name="product_id"]').val());var a=(e("#product-addons-total").data("price_data")||[]).reduce((function(e,t){return e+t.cost}),0);return n.makeRequest("get_selected_product_data",{security:dokanStripeExpressPRData.nonce.getSelectedProductData,product_id:t,qty:e(".quantity .qty").val(),attributes:e(".variations_form").length?n.getAttributes().data:[],addon_value:a})},debounce:(e,t,a)=>{var n;return function(){var s=this,i=arguments,r=a&&!n;clearTimeout(n),n=setTimeout((function(){n=null,a||t.apply(s,i)}),e),r&&t.apply(s,i)}},createPaymentRequestButton:(e,t)=>e.create("paymentRequestButton",{paymentRequest:t,style:{paymentRequestButton:{type:dokanStripeExpressPRData.button.type,theme:dokanStripeExpressPRData.button.theme,height:dokanStripeExpressPRData.button.height+"px"}}}),isCustomPRButton:e=>e&&"function"==typeof e.data&&e.data("isCustom"),isBrandedPRButton:e=>e&&"function"==typeof e.data&&e.data("isBranded"),attachBtnEventListeners:(t,a)=>{t.on("click",(function(t){e("body").addClass("dokan-stripe-express-pay-req-btn-clicked")})),dokanStripeExpressPRData.isProductPage?n.attachProductPageEventListeners(t,a):n.attachCartPageEventListeners(t,a)},attachProductPageEventListeners:(a,s)=>{var i=[],r=e(".single_add_to_cart_button");a.on("click",(function(e){if(dokanStripeExpressPRData.loginStatus)return e.preventDefault(),void n.verifyLoginRequirement(t);if(r.is(".disabled")){if(e.preventDefault(),r.is(".wc-variation-is-unavailable"))return dokan_sweetalert(dokanStripeExpressPRData.i18n.makeSelection,{action:"alert",icon:"warning",timer:2200});if(r.is(".wc-variation-selection-needed"))return dokan_sweetalert(dokanStripeExpressPRData.i18n.productUnavailable,{action:"alert",icon:"warning",timer:2200})}if(i.length)return e.preventDefault(),dokan_sweetalert(i,{action:"alert",icon:"error",timer:2200});n.addToCart(),(n.isCustomPRButton(a)||n.isBrandedPRButton(a))&&(e.preventDefault(),s.show())})),e(document.body).on("dokan_stripe_express_unblock_payment_request_button dokan_stripe_express_enable_payment_request_button",(function(){n.unblockPaymentRequestButton()})),e(document.body).on("dokan_stripe_express_block_payment_request_button",(function(){n.blockPaymentRequestButton("wc_request_button_is_blocked")})),e(document.body).on("dokan_stripe_express_disable_payment_request_button",(function(){n.blockPaymentRequestButton("wc_request_button_is_disabled")})),e(document.body).on("woocommerce_variation_has_changed",(function(){e(document.body).trigger("dokan_stripe_express_block_payment_request_button"),e.when(n.getSelectedProductData()).then((function(t){e.when(s.update({total:t.total,displayItems:t.displayItems})).then((function(){e(document.body).trigger("dokan_stripe_express_unblock_payment_request_button")}))}))})),e(".quantity").on("input",".qty",(function(){e(document.body).trigger("dokan_stripe_express_block_payment_request_button")})),e(".quantity").on("input",".qty",n.debounce(250,(function(){e(document.body).trigger("dokan_stripe_express_block_payment_request_button"),i=[],e.when(n.getSelectedProductData()).then((function(t){t.error?(i=[t.error],e(document.body).trigger("dokan_stripe_express_unblock_payment_request_button")):e.when(s.update({total:t.total,displayItems:t.displayItems})).then((function(){e(document.body).trigger("dokan_stripe_express_unblock_payment_request_button")}))}))}))),e(".variations_form").length&&e(".variations_form").on("found_variation.wc-variation-form",(function(e,t){t.is_in_stock?n.unhidePaymentRequestButton():n.hidePaymentRequestButton()}))},attachCartPageEventListeners:(e,a)=>{e.on("click",(function(s){if(dokanStripeExpressPRData.loginStatus)return s.preventDefault(),void n.verifyLoginRequirement(t);(n.isCustomPRButton(e)||n.isBrandedPRButton(e))&&(s.preventDefault(),a.show())}))},showPaymentRequestButton:t=>{n.isCustomPRButton(t)?(t.addClass("is-active"),e("#dokan-stripe-express-payment-request-wrapper, #dokan-stripe-express-payment-request-button-separator").show()):n.isBrandedPRButton(t)?(e("#dokan-stripe-express-payment-request-wrapper, #dokan-stripe-express-payment-request-button-separator").show(),e("#dokan-stripe-express-payment-request-button").html(t)):e("#dokan-stripe-express-payment-request-button").length&&(e("#dokan-stripe-express-payment-request-wrapper, #dokan-stripe-express-payment-request-button-separator").show(),t.mount("#dokan-stripe-express-payment-request-button"))},hidePaymentRequestButton:()=>{e("#dokan-stripe-express-payment-request-wrapper, #dokan-stripe-express-payment-request-button-separator").hide()},unhidePaymentRequestButton:()=>{const t=e("#dokan-stripe-express-payment-request-wrapper"),a=e("#dokan-stripe-express-payment-request-button-separator");(t.is(":hidden")||a.is(":hidden"))&&(t.show(),a.show())},blockPaymentRequestButton:t=>{e("#dokan-stripe-express-payment-request-button").data("blockUI.isBlocked")||e("#dokan-stripe-express-payment-request-button").addClass(t).block({message:null})},unblockPaymentRequestButton:()=>{e("#dokan-stripe-express-payment-request-button").removeClass(["wc_request_button_is_blocked","wc_request_button_is_disabled"]).unblock()},verifyLoginRequirement:e=>{if(dokanStripeExpressPRData.loginStatus){var t=dokanStripeExpressPRData.loginStatus.message;"payment_request_api"!==e&&(t=t.replace(/\*\*.*?\*\*/,"apple_pay"===e?dokanStripeExpressPRData.i18n.applePay:dokanStripeExpressPRData.i18n.googlePay)),t=t.replace(/\*\*/g,""),dokan_sweetalert(t,{action:"confirm",icon:"warning",confirmButtonColor:"#363636",cancelButtonColor:"#b54545",confirmButtonText:dokanStripeExpressPRData.i18n.login,cancelButtonText:dokanStripeExpressPRData.i18n.cancel}).then((e=>{e.isConfirmed&&(window.location.href=dokanStripeExpressPRData.loginStatus.redirect_url)}))}},init:()=>{dokanStripeExpressPRData.isProductPage?n.startPaymentRequest(""):n.getCartDetails()}};n.init(),e(document.body).on("updated_cart_totals",(function(){n.init()})),e(document.body).on("updated_checkout",(function(){n.init()}))}(jQuery);